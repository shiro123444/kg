# 系统架构说明

## 架构概览

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|    前端应用      |     |     API 层       |     |    数据层        |
|   (Next.js)      | <-> |   (API Routes)   | <-> |    (Neo4j)      |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
         |                        |                       ^
         |                        |                       |
         v                        v                       |
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|   可视化组件     |     |  GraphRAG 服务   |     |  知识图谱数据    |
|   (D3.js)        |     | (检索&生成)      |     | (JSON → Neo4j)   |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
                                  |
                                  v
                         +------------------+
                         |                  |
                         |  DeepSeek API    |
                         |   (大语言模型)    |
                         |                  |
                         +------------------+
```

## 核心组件说明

### 1. 前端应用层 (Next.js)

- **主页面** (`src/app/page.tsx`)
  - 提供问答和可视化两个主要功能入口
  - 使用 Tab 组件切换不同视图

- **聊天界面** (`src/components/chat/ChatInterface.tsx`)
  - 用户输入问题
  - 显示对话历史
  - 展示检索到的上下文信息

- **知识图谱可视化** (`src/components/visualization/KnowledgeGraph.tsx`)
  - 使用 D3.js 实现交互式图可视化
  - 支持节点拖拽、缩放、高亮等功能

### 2. API 层

- **图数据 API** (`src/app/api/graph/route.ts`)
  - 提供知识图谱数据查询接口
  - 返回适合 D3.js 渲染的节点和关系数据

- **聊天 API** (`src/app/api/chat/route.ts`)
  - 接收用户问题
  - 调用 GraphRAG 服务处理请求
  - 返回生成的答案和上下文

### 3. GraphRAG 服务层

- **检索器** (`src/lib/graphrag/retriever.ts`)
  - 从知识图谱中检索相关实体和关系
  - 实现基于图的上下文检索

- **RAG 服务** (`src/lib/graphrag/service.ts`)
  - 协调检索和生成过程
  - 格式化上下文信息
  - 调用 DeepSeek API 生成答案

### 4. 数据访问层

- **Neo4j 配置** (`src/lib/neo4j/config.ts`)
  - 管理数据库连接
  - 提供会话管理功能

- **查询接口** (`src/lib/neo4j/queries.ts`)
  - 封装常用的 Cypher 查询
  - 提供数据转换功能

### 5. 外部服务集成

- **DeepSeek 客户端** (`src/lib/deepseek/client.ts`)
  - 封装 DeepSeek API 调用
  - 提供专门的问答生成方法

## 数据流程

1. **问答流程**：
   ```
   用户输入 → API 路由 → GraphRAG 检索 → Neo4j 查询 
   → 上下文格式化 → DeepSeek API → 答案生成 → 前端展示
   ```

2. **可视化流程**：
   ```
   前端请求 → API 路由 → Neo4j 查询 → 数据转换 
   → D3.js 渲染 → 用户交互
   ```

3. **数据导入流程**：
   ```
   JSON 文件 → 导入脚本 → Neo4j 数据库
   ```

## 关键技术选型

1. **Next.js 15**：现代化的 React 框架，支持 App Router 和服务端渲染
2. **Neo4j**：专业的图数据库，适合存储知识图谱
3. **D3.js**：强大的数据可视化库，适合图结构渲染
4. **DeepSeek API**：国产大语言模型，提供高质量的文本生成
5. **TypeScript**：提供类型安全和更好的开发体验

## 性能优化

1. **数据库优化**
   - 使用索引加速查询
   - 限制返回数据量
   - 使用连接池管理

2. **前端优化**
   - 使用虚拟化技术处理大量节点
   - 懒加载组件
   - 缓存常用数据

3. **API 优化**
   - 实现请求缓存
   - 批量处理请求
   - 错误重试机制

## 扩展性设计

1. **模块化架构**：各组件独立，易于替换和升级
2. **接口抽象**：通过接口定义实现松耦合
3. **配置外置**：重要参数通过环境变量配置
4. **插件机制**：预留扩展点，方便添加新功能

## 部署考虑

1. **容器化**：支持 Docker 部署
2. **环境分离**：开发、测试、生产环境配置分离
3. **监控告警**：集成日志和性能监控
4. **自动化**：CI/CD 流程支持
